<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
      // Datalabels 플러그인 등록
      Chart.register(ChartDataLabels);
    </script>

    <style>
      #chartContainer {
        width: 1000px;
        height: 800px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
      }
      .chart-wrapper {
        width: 48%;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      canvas {
        width: 100% !important;
        height: 100% !important;
      }
      select,
      button {
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Progress Charts</h1>
    <select id="yearSelect"></select>
    <button onclick="loadCharts()">Load Charts</button>

    <div id="chartContainer">
      <div class="chart-wrapper">
        <canvas id="registrationProgressChart"></canvas>
      </div>
      <div class="chart-wrapper">
        <canvas id="projectProgressChart"></canvas>
      </div>
      <div class="chart-wrapper">
        <canvas id="projectStatusChart"></canvas>
      </div>
      <div class="chart-wrapper">
        <canvas id="projectCompletionChart"></canvas>
      </div>
    </div>

    <script>
      const colors = [
        "rgba(65, 90, 119, 0.8)",
        "rgba(118, 107, 141, 0.8)",
        "rgba(168, 218, 220, 0.8)",
        "rgba(119, 141, 169, 0.8)",
        "rgba(142, 202, 230, 0.8)",
        "rgba(181, 131, 141, 0.8)",
        "rgba(201, 203, 207, 0.8)",
        "rgba(245, 198, 106, 0.8)",
        "rgba(127, 167, 27, 0.8)",
        "rgba(181, 126, 43, 0.8)",
      ];

      let registrationChart;
      let projectChart;
      let projectStatusChart;
      let projectCompletionChart;

      async function fetchYearOptions() {
        try {
          const response = await fetch("http://localhost:3000/years");
          const years = await response.json();
          const yearSelect = document.getElementById("yearSelect");
          yearSelect.innerHTML = years
            .map((year) => `<option value="${year}">${year}</option>`)
            .join("");
        } catch (error) {
          console.error("Error fetching year options:", error);
        }
      }

      function processProjectStatusDataForPie(data) {
        const statusCounts = data.reduce((acc, item) => {
          acc[item.진행상태] = (acc[item.진행상태] || 0) + item.항목수;
          return acc;
        }, {});

        const labels = Object.keys(statusCounts);
        const values = Object.values(statusCounts);

        return {
          labels: labels,
          datasets: [
            {
              label: "프로젝트 진행 상태",
              data: values,
              backgroundColor: labels.map(
                (_, index) => colors[index % colors.length]
              ),
              borderColor: labels.map((_, index) =>
                colors[index % colors.length].replace("0.8", "1")
              ),
              borderWidth: 1,
            },
          ],
        };
      }

      async function loadCharts() {
        try {
          const year = document.getElementById("yearSelect").value;
          if (!year) return;

          const [
            registrationData,
            projectData,
            projectStatusData,
            projectCompletionData,
          ] = await Promise.all([
            fetch(
              `http://localhost:3000/registrationProgress?year=${year}`
            ).then((res) => res.json()),
            fetch(`http://localhost:3000/projectProgress?year=${year}`).then(
              (res) => res.json()
            ),
            fetch(`http://localhost:3000/projectStatus?year=${year}`).then(
              (res) => res.json()
            ),
            fetch(`http://localhost:3000/projectCompletion?year=${year}`).then(
              (res) => res.json()
            ),
          ]);

          // 기존 차트 제거
          if (registrationChart) registrationChart.destroy();
          if (projectChart) projectChart.destroy();
          if (projectStatusChart) projectStatusChart.destroy();
          if (projectCompletionChart) projectCompletionChart.destroy();

          // 등록구분별 진행률 차트
          registrationChart = new Chart(
            document.getElementById("registrationProgressChart"),
            {
              type: "bar",
              data: {
                labels: Array.from({ length: 12 }, (_, i) => `C${i + 1}`),
                datasets: [
                  {
                    label: "등록구분별 건수",
                    data: registrationData.values,
                    backgroundColor: colors,
                    borderColor: colors.map((color) =>
                      color.replace("0.8", "1")
                    ),
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                plugins: {
                  datalabels: {
                    color: "#000",
                    formatter: (value) => `${value}건`,
                    align: "center",
                    anchor: "center",
                    font: {
                      weight: "bold",
                      size: 12,
                    },
                  },
                },
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "진행률 건수",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "등록구분",
                    },
                  },
                },
              },
            }
          );

          // 프로젝트별 진행률 차트
          projectChart = new Chart(
            document.getElementById("projectProgressChart"),
            {
              type: "bar",
              data: {
                labels: projectData.labels,
                datasets: [
                  {
                    label: "프로젝트별 건수",
                    data: projectData.values,
                    backgroundColor: colors,
                    borderColor: colors.map((color) =>
                      color.replace("0.8", "1")
                    ),
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                plugins: {
                  datalabels: {
                    color: "#000",
                    formatter: (value) => `${value}건`,
                    align: "center",
                    anchor: "center",
                    font: {
                      weight: "bold",
                      size: 12,
                    },
                  },
                },
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "진행률 건수",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "프로젝트",
                    },
                  },
                },
              },
            }
          );

          // 프로젝트 진행 상태 차트 (도넛 차트)
          const processedProjectStatusDataForPie =
            processProjectStatusDataForPie(projectStatusData);

          projectStatusChart = new Chart(
            document.getElementById("projectStatusChart"),
            {
              type: "doughnut",
              data: processedProjectStatusDataForPie,
              options: {
                plugins: {
                  datalabels: {
                    color: "#000",
                    formatter: (value, context) => {
                      const label =
                        context.chart.data.labels[context.dataIndex];
                      const originalValue =
                        processedProjectStatusDataForPie.datasets[0].data[
                          context.dataIndex
                        ];
                      return `${originalValue}건`;
                    },
                    align: "center",
                    anchor: "center",
                    font: {
                      weight: "bold",
                      size: 12,
                    },
                  },
                },
                responsive: true,
                maintainAspectRatio: false,
              },
            }
          );

          // 프로젝트 완료율 차트
          projectCompletionChart = new Chart(
            document.getElementById("projectCompletionChart"),
            {
              type: "bar",
              data: {
                labels: projectCompletionData.map((item) => item.프로젝트),
                datasets: [
                  {
                    label: "프로젝트 완료율",
                    data: projectCompletionData.map((item) => item.진행률),
                    backgroundColor: colors,
                    borderColor: colors.map((color) =>
                      color.replace("0.8", "1")
                    ),
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                plugins: {
                  datalabels: {
                    color: "#000",
                    formatter: (value) => `${value}%`,
                    align: "center",
                    anchor: "center",
                    font: {
                      weight: "bold",
                      size: 12,
                    },
                  },
                },
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "완료율 (%)",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "프로젝트",
                    },
                  },
                },
              },
            }
          );
        } catch (error) {
          console.error("Error loading charts:", error);
        }
      }

      fetchYearOptions();
    </script>
  </body>
</html>
